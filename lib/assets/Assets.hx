package assets;

import haxe.DynamicAccess;
import js.Browser;
import js.lib.Error;
import assets.Manifest;
import assets.fonts.FontsManager;
import assets.scripts.ScriptsManager;
import assets.texts.TextsManager;
import assets.utils.Dispatcher;

/**
 * –ú–∞—Å—Ç–µ—Ä –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤.  
 * 
 * –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ
 * ------------
 * –†–µ—Å—É—Ä—Å—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –∏–≥—Ä–µ –æ—á–µ–Ω—å —Ä–∞–∑–Ω—ã–µ, –∞ —Å–ø–æ—Å–æ–±—ã –∏—Ö
 * –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ - —Ç–µ–º–±–æ–ª–µ–µ! –≠—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç
 * –æ–¥–Ω—É –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç—É—é –ø–æ —Å–º—ã—Å–ª—É –∑–∞–¥–∞—á—É:  
 * *–Ø —É–∫–∞–∑–∞–ª —Å–ø–∏—Å–æ–∫, –∞ —Ç—ã –∑–∞–≥—Ä—É–∑–∏ –∏ –ø–æ–¥–∫–ª—é—á–∏ –≤—Å—ë –∫–∞–∫ –Ω–∞–¥–æ!*
 * 
 * –≠—Ç–æ –æ–±—â–∏–π –æ–±—ä–µ–∫—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º–∏ **—Ç–∏–ø–∞–º–∏** —Ä–µ—Å—É—Ä—Å–æ–≤.
 * –û–Ω –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è –Ω–µ—Å–∫–æ–ª—å–∫–æ –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤,
 * —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —Ç–∏–ø–µ –¥–∞–Ω–Ω—ã—Ö. –ë–æ–ª–µ–µ
 * –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–Ω–æ –ø–æ—á–∏—Ç–∞—Ç—å –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
 * –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞: `assets.Manager`.
 * 
 * –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
 * ------------
 * –°–ø–µ—Ä–≤–∞ –≤—ã –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å –æ–±—ä–µ–∫—Ç `Assets`, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç
 * –∑–∞–≤–µ–¥–æ–≤–∞—Ç—å –≤—Å–µ–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–∂–µ
 * –≥–æ—Ç–æ–≤—ã–π, –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç: `Assets.global`. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º
 * –¥–æ—Å—Ç—É–ø –∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º —Å–º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –ª—é–±–∞—è JS –ø—Ä–æ–≥—Ä–∞–º–º–∞
 * –≤ —Ä–∞–º–∫–∞—Ö –¥–∞–Ω–Ω–æ–π web —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –ù–æ –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π
 * —ç–∫–∑–µ–º–ø–ª—è—Ä `Assets`.
 * 
 * –î–∞–ª–µ–µ –Ω—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Å–ø–æ—Å–æ–± –∑–∞–≥—Ä—É–∑–∫–∏: –ø–æ –æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É –∏–ª–∏ —Å
 * –ø–æ–º–æ—â—å—é –æ–ø–∏—Å–∞–Ω–∏—è –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (–ú–∞–Ω–∏—Ñ–µ—Å—Ç). –í—Ç–æ—Ä—ã–º
 * —Å–ø–æ—Å–æ–±–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —É–¥–æ–±–Ω–µ–µ.  
 * –ü—Ä–∏–º–µ—Ä:
 * ```
 * var manifest:Manifest =
 * {
 *     fonts: [
 *         { family:"Sansita One", source:"fonts/Sansita One.ttf" },
 *     ],
 *     scripts:[
 *         { url:"js/lib/pixi.min.js", },
 *         { url:"js/lib/pixi-filters.js", },
 *         { url:"js/lib/pixi-sound.js", },
 *     ],
 *     l10n:[
 *         { localization:"ru", url:"lang/ru.csv" },
 *         { localization:"en", url:"lang/en.csv" },
 *     ],
 * }
 * Assets.global.add(manifest);
 * Assets.global.load(function(){ trace("All data loaded!"); });
 * ```
 * –ö–æ–≥–¥–∞ —Ä–µ—Å—É—Ä—Å—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é, –≤—ã
 * —É–≤–∏–¥–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ: `All data loaded!`.
 */
class Assets
{
    private var map:DynamicAccess<Manager<Dynamic, Dynamic>> = {};
    private var arr:Array<Manager<Dynamic, Dynamic>> = [];

    /**
     * –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –≤–Ω–µ—à–Ω–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤.
     */
    public function new() {
        onComplete = new Dispatcher();
        onCompleteAll = new Dispatcher();

        // –ë–∞–∑–æ–≤—ã–µ —Ç–∏–ø—ã —Ä–µ—Å—É—Ä—Å–æ–≤:
        addManager(new FontsManager());
        addManager(new ScriptsManager());
        addManager(new TextsManager());

        // –†–∞—Å—à–∏—Ä–µ–Ω–∏—è:
        #if l10n
        addManager(new assets.l10n.L10nManager());
        #end
        
        #if pixi
        addManager(new assets.pixi.SoundsManager());
        addManager(new assets.pixi.TexturesManager());
        #end
    }

    /**
     * –î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö.  
     * –° –ø–æ–º–æ—â—å—é —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞ –º–æ–∂–Ω–æ —É–¥–æ–±–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
     * –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —Ä–µ—Å—É—Ä—Å–æ–≤.  
     * –í—ã–∑–æ–≤ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è, –µ—Å–ª–∏ –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω `null`.
     * @param manager –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö.
     * @throws Error –ú–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.
     */
    public function addManager(manager:Manager<Dynamic,Dynamic>):Void {
        if (manager == null)
            return;
        if (map[manager.type] != null)
            throw new Error("The Manager for data type=" + manager.type + " is already added");

        manager.onComplete.on(onResourceComplete);

        map[manager.type] = manager;
        arr.push(manager);
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞.  
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞, –∏–ª–∏ `null`,
     * –µ—Å–ª–∏ —Ç–∞–∫–æ–≥–æ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ.
     * @param type –¢–∏–ø —Ä–µ—Å—É—Ä—Å–æ–≤.
     * @return –ú–µ–Ω–µ–¥–∂–µ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞.
     */
    public function getManager(type:ResourceType):Manager<Dynamic, Dynamic> {
        var item = map[type];
        if (item == null)
            return null;

        return untyped item;
    }

    /**
     * –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –≤—Å–µ–π web —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
     * - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤ `window.assets`.
     * - –î–æ—Å—Ç—É–ø –∫ —ç—Ç–æ–º—É —ç–∫–∑–µ–º–ø–ª—è—Ä—É –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –ª—é–±–æ–µ Haxe –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
     * - –≠–∫–∑–µ–º–ø–ª—è—Ä –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ —ç—Ç–æ–≥–æ –≥–µ—Ç—Ç–µ—Ä–∞.
     * 
     * –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å `null`
     */
    static public var global(get, null):Assets;
    @:noCompletion
    static public function get_global():Assets {
        var v:Assets = untyped Browser.window.assets;
        if (v == null) {
            v = new Assets();
            untyped Browser.window.assets = v;
        }
        return v;
    }

    /**
     * –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ—Ö –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤. (–®—Ç—É–∫)
     * 
     * –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏.
     * –ü—Ä–∏ –≤—ã–∑–æ–≤–µ —ç—Ç–æ—Ç —Å—á—ë—Ç—á–∏–∫ –ø–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É `total`
     * —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö —Å–≤–æ–∏—Ö –¥–æ—á–µ—Ä–Ω–∏—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤.
     * 
     * –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `0`
     */
    public var total(get, never):Int;
    @:noCompletion
    function get_total():Int {
        var sum = 0;
        var i = arr.length;
        while (i-- != 0)
            sum += arr[i].total;
        return sum;
    }

    /**
     * –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç. (–®—Ç—É–∫)  
     * 
     * –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏.
     * –ü—Ä–∏ –≤—ã–∑–æ–≤–µ —ç—Ç–æ—Ç —Å—á—ë—Ç—á–∏–∫ –ø–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É `loading`
     * —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö —Å–≤–æ–∏—Ö –¥–æ—á–µ—Ä–Ω–∏—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤.
     * 
     * –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `0`
     */
    public var loading(get, never):Int;
    @:noCompletion
    function get_loading():Int {
        var sum = 0;
        var i = arr.length;
        while (i-- != 0)
            sum += arr[i].loading;
        return sum;
    }

    /**
     * –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤, –≥–æ—Ç–æ–≤—ã—Ö –∫ —Ä–∞–±–æ—Ç–µ. (–®—Ç—É–∫)
     * 
     * –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏.
     * –ü—Ä–∏ –≤—ã–∑–æ–≤–µ —ç—Ç–æ—Ç —Å—á—ë—Ç—á–∏–∫ –ø–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É `loaded`
     * —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö —Å–≤–æ–∏—Ö –¥–æ—á–µ—Ä–Ω–∏—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤.
     * 
     * –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `0`
     */
    public var loaded(get, never):Int;
    @:noCompletion
    function get_loaded():Int {
        var sum = 0;
        var i = arr.length;
        while (i-- != 0)
            sum += arr[i].loaded;
        return sum;
    }

    /**
     * –°–æ–±—ã—Ç–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –æ–¥–Ω–æ–≥–æ –∏–∑ —Ä–µ—Å—É—Ä—Å–æ–≤.
     * 
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Ä–∞–∑–±–æ—Ä–∞ –æ–¥–Ω–æ–≥–æ
     * –∏–∑ —Ä–µ—Å—É—Ä—Å–æ–≤. –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
     * –∑–∞–≥—Ä—É–∑–∫–∏.
     * 
     * –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
     * - –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ –ø–æ—Å—ã–ª–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞
     *   –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –µ–≥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –∏ —Ä–∞–∑–±–æ—Ä–∞.
     * - –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ –ø–æ—Å—ã–ª–∞–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∏–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
     *   –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å –æ—à–∏–±–∫–æ–π. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å—Å—è
     *   –≤ —Å–≤–æ–π—Å—Ç–≤–µ: `resource.error`.
     * 
     * –ü—Ä–∏–º–µ—Ä:
     * ```
     * Assets.global.onComplete.on(function(res){ trace("Complete!", res, res.error); });
     * ```
     * –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å `null`
     */
    public var onComplete(default, null):Dispatcher<Resource<Dynamic,Dynamic>->Void>;

    /**
     * –°–æ–±—ã—Ç–∏–µ –æ–±—â–µ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤.
     * 
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö
     * –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ —ç—Ç–æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä. –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–µ–∑–∏—Ä—É–µ—Ç—Å—è
     * —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –∏ –≤—Å–µ–≥–¥–∞ –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ.
     * 
     * –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
     * - –ï—Å–ª–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—ã –¥–æ–±–∞–≤–∏—Ç–µ –µ—â—ë –æ–¥–∏–Ω –∏–ª–∏ –±–æ–ª–µ–µ
     *   –Ω–æ–≤—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤, —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω–æ **–ø–æ–≤—Ç–æ—Ä–Ω–æ** –ø–æ—Å–ª–µ
     *   –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
     * - –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–µ–∑–∏—Ä—É–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –±—ã–ª–∞ **–æ—à–∏–±–∫–∞**
     *   –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–¥–Ω–æ–≥–æ, –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–ª–∏ –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–æ–≤.
     * 
     * –ü—Ä–∏–º–µ—Ä:
     * ```
     * Assets.global.onCompleteAll.once(function(){ trace("All complete!"); });
     * ```
     * –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å `null`
     */
    public var onCompleteAll(default, null):Dispatcher<Void->Void>;

    /**
     * –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤.  
     * –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ —É–¥–æ–±–µ–Ω –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –∑–∞ —Ä–∞–∑.
     * –ù–æ –≤—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏
     * –≤ –∫–∞–∂–¥–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –º–µ–Ω–µ–¥–∂–µ—Ä–µ —Ä–µ—Å—É—Ä—Å–æ–≤.
     * @param manifest –û–±—ä–µ–∫—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤.
     */
    public function add(manifest:Manifest):Void {
        var i = arr.length;
        while (i-- != 0)
            arr[i].addManifest(manifest);
    }

    /**
     * –ù–∞—á–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –Ω–æ–≤—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤. üêå  
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true`, –µ—Å–ª–∏ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –±—ã–ª–∏ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É.
     * - –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞ –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è
     *   –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –∑–∞–≥—Ä—É–∑–∫–∏, –µ—Å–ª–∏ –≤—ã —ç—Ç–æ–≥–æ –µ—â—ë –Ω–µ —Å–¥–µ–ª–∞–ª–∏.
     * - –≠—Ç–æ—Ç –≤—ã–∑–æ–≤ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã, –æ–Ω
     *   –ø—Ä–æ—Å—Ç–æ –Ω–∞—á–∏–Ω–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –Ω–æ–≤—ã—Ö.
     * - –ö–æ–ª–±–µ–∫ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –µ—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã.
     *   (–í—ã –ø–µ—Ä–µ–¥–∞–ª–∏ –ø—É—Å—Ç–æ–π –º–∞–Ω–∏—Ñ–µ—Å—Ç?)
     * @param callback –ö–æ–ª–±–µ–∫, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö.
     *                 –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≤—ã–∑–æ–≤—É: `assets.onCompleteAll.once(callback);`
     * @return –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true`, –µ—Å–ª–∏ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –±—ã–ª–∏ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É.
     */
    public function load(?callback:Void->Void):Bool {
        var hasNewLoads = false;
        var i = arr.length;
        while (i-- != 0) {
            if (arr[i].load())
                hasNewLoads = true;
        }

        if (hasNewLoads)
            onCompleteAll.once(callback);
        else
            callback();

        return hasNewLoads;
    }

    private function onResourceComplete(res:Resource<Dynamic, Dynamic>) {
        onComplete.emit(res);
        if (total == loaded)
            onCompleteAll.emit();
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —ç—Ç–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞.
     * @return –°—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞.
     */
    @:keep
    @:noCompletion
    public function toString():String {
        return '[Assets total=' + total + ']';
    }
}