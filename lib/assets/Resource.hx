package assets;

import js.lib.Error;
import assets.utils.Dispatcher;

/**
 * –í–Ω–µ—à–Ω–∏–π —Ä–µ—Å—É—Ä—Å.  
 * –≠—Ç–æ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π, –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ä–µ—Å—É—Ä—Å–æ–≤. –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –≤—ã
 * –∑–∞—Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ —ç—Ç–æ—Ç –∫–ª–∞—Å—Å, –∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø —Ä–µ—Å—É—Ä—Å–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:
 * `assets.fonts.FontResource`.
 * 
 * –≠—Ç–æ—Ç –∫–ª–∞—Å—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–±—Å—Ç—Ä–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—â–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤
 * —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∫–ª–∞—Å—Å–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–π
 * –ª–æ–≥–∏–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏/–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞ —Ä–µ—Å—É—Ä—Å–∞.
 */
class Resource<R:Resource<R,P>, P>
{
    /**
     * –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ—Å—É—Ä—Å.
     * @param manager –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ä–µ—Å—É—Ä—Å.
     * @param id ID –†–µ—Å—É—Ä—Å–∞.
     * @param type –¢–∏–ø —Ä–µ—Å—É—Ä—Å–∞.
     * @param params –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.
     * @throws Error –ú–µ–Ω–µ–¥–∂–µ—Ä –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `null`
     * @throws Error ID –†–µ—Å—É—Ä—Å–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `null`
     * @throws Error –¢–∏–ø —Ä–µ—Å—É—Ä—Å–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `null`
     * @throws Error –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ—Å—É—Ä—Å–∞ –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å `null`
     */
    private function new(manager:Manager<R,P>, id:String, type:ResourceType, params:P) {
        if (manager == null)    throw new Error("The parent manager cannot be null");
        if (id == null)         throw new Error("Resource id cannot be null");
        if (type == null)       throw new Error("Resource type cannot be null");
        if (params == null)     throw new Error("Resource params cannot be null");

        this.manager = manager;
        this.id = id;
        this.type = type;
        this.params = params;
        this.onComplete = new Dispatcher();
    }

    /**
     * –°–æ–±—ã—Ç–∏–µ `onCompleteAll` –¥–ª—è —ç—Ç–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞ –Ω–µ –ø–æ—Å—ã–ª–∞–ª–æ—Å—å.  
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è
     * –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –¥–∏—Å–ø–µ—Ç—á–µ—Ä–µ–∑–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ —Å–æ–±—ã—Ç–∏—è.
     * 
     * –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `false`
     */
    @:allow(assets.Manager)
    private var isEmitCompleteAll:Bool = false;

    /**
     * ID –†–µ—Å—É—Ä—Å–∞.  
     * –£–Ω–∏–∫–∞–ª–µ–Ω –≤ —Ä–∞–º–∫–∞—Ö —Å–≤–æ–µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ `manager`.
     * 
     * –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å `null`
     */
    public var id(default, null):String;

    /**
     * –¢–∏–ø —Ä–µ—Å—É—Ä—Å–∞.  
     * –£–¥–æ–±–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ —ç—Ç–æ–≥–æ
     * —Ä–µ—Å—É—Ä—Å–∞. (–ö–ª–∞—Å—Å–∞)
     * 
     * –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å `null`
     */
    public var type(default, null):ResourceType;

    /**
     * –°–ø–∏—Å–æ–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä.  
     * –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å `null`
     */
    public var params(default, null):P;

    /**
     * –†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–µ—Å—É—Ä—Å–æ–≤.  
     * –ö–∞–∂–¥—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Ä–µ—Å—É—Ä—Å–∞ –∏–º–µ–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ —Å–≤–æ–π —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π
     * –º–µ–Ω–µ–¥–∂–µ—Ä, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –æ–Ω –æ—Ç–Ω–æ—Å–∏—Ç—Å—è. –≠—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –≤
     * –æ—Å–Ω–æ–≤–Ω–æ–º –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.
     *  
     * –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å `null`
     */
    public var manager(default, null):Manager<R,P>;

    /**
     * –°–æ–±—ã—Ç–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏.  
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–ª–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏
     * —Ä–∞–∑–±–æ—Ä–∞ —ç—Ç–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞.
     * 
     * –ü—Ä–∏–º–µ—Ä:
     * ```
     * resource.onComplete.once(function(res){ trace("–°omplete!", res.error); });
     * ```
     * –ù–µ –º–æ–∂–µ—Ç –±—ã—Ç—å `null`
     */
    public var onComplete(default, null):Dispatcher<R->Void>;

    /**
     * –†–µ—Å—É—Ä—Å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è.  
     * –§–ª–∞–≥ —Ä–∞–≤–µ–Ω `true`, –µ—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —ç—Ç–æ—Ç —Ä–µ—Å—É—Ä—Å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è.
     * 
     * –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `false`
     */
    public var isLoading(default, null):Bool = false;

    /**
     * –†–µ—Å—É—Ä—Å –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.  
     * –ü–µ—Ä–µ–¥ –¥–æ—Å—Ç—É–ø–æ–º –∫ –¥–∞–Ω–Ω—ã–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–π—Å—Ç–≤–æ `error` –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç
     * –Ω–∞–ª–∏—á–∏—è –æ—à–∏–±–∫–∏.
     * 
     * –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `false`
     */
    public var isComplete(default, null):Bool = false;

    /**
     * –†–µ—Å—É—Ä—Å –≤—ã–≥—Ä—É–∂–µ–Ω.  
     * –≠—Ç–æ —Å–≤–æ–π—Å—Ç–≤–æ —Ä–∞–≤–Ω–æ `true`, –µ—Å–ª–∏ –±—ã–ª –≤—ã–∑–≤–∞–Ω –º–µ—Ç–æ–¥ `dispose()`.
     * –¢–∞–∫–æ–π —Ä–µ—Å—É—Ä—Å –±–æ–ª–µ–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω, –≤—Å–µ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
     * —É–Ω–∏—á—Ç–æ–∂–µ–Ω—ã.
     * 
     * –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `false`
     */
    public var isDisposed(default, null):Bool = false;

    /**
     * –û—à–∏–±–∫–∞.  
     * –≠—Ç–æ —Å–≤–æ–π—Å—Ç–≤–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ —Ç–∞–∫–∞—è –ø—Ä–æ–∏–∑–æ—à–ª–∞
     * –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–ª–∏ —Ä–∞–∑–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö —ç—Ç–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞.
     * 
     * –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `null`
     */
    public var error:Error = null;

    /**
     * –ù–∞—á–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ä–µ—Å—É—Ä—Å–∞.  
     * –ú–µ—Ç–æ–¥ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤
     * –ø–æ–¥–∫–ª–∞—Å—Å–µ. –í—ã–∑–æ–≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –º–µ—Ç–æ–¥–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è!
     * @throws Error –ú–µ—Ç–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ –ø–æ–¥–∫–ª–∞—Å—Å–µ.
     */
    @:allow(assets.Manager)
    private function load():Void {
        throw new Error("Method not implemented");
    }

    /**
     * –£–Ω–∏—á—Ç–æ–∂–∏—Ç—å —ç—Ç–æ—Ç —Ä–µ—Å—É—Ä—Å. üî•  
     * –í—ã–∑–æ–≤ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è, –µ—Å–ª–∏ —ç—Ç–æ—Ç —Ä–µ—Å—É—Ä—Å —É–∂–µ –±—ã–ª –≤—ã–≥—Ä—É–∂–µ–Ω.
     * - –í—ã–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —ç—Ç–∏–º —Ä–µ—Å—É—Ä—Å–æ–º.
     * - –û—á–∏—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–ª—É—à–∞—Ç–µ–ª–µ–π `onComplete=null`.
     * - –£–¥–∞–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç –∏–∑ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ `manager=null`.
     * - –£–¥–∞–ª—è–µ—Ç –æ—à–∏–±–∫—É `error=null`.
     * - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–≤–æ–π—Å—Ç–≤–æ `isDisposed=true`.
     * 
     * –í—ã –±–æ–ª—å—à–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç!
     */
    public function dispose():Void {
        if (isDisposed)
            return;

        isDisposed = true;

        manager.remove(id);
        onComplete.clear();

        onComplete = null;
        manager = null;
        error = null;
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —ç—Ç–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞.
     * @return –°—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞.
     */
    @:keep
    @:noCompletion
    public function toString():String {
        return "[Resource id=" + id + "]";
    }
}